<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cadastro Sala de Leitura</title>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  // Configuração Firebase (sua config)
  const firebaseConfig = {
    apiKey: "AIzaSyC72gBi7POz-NqEMWKgu54S9vTyr0oFkzs",
    authDomain: "cadsl-3ef8f.firebaseapp.com",
    projectId: "cadsl-3ef8f",
    storageBucket: "cadsl-3ef8f.appspot.com",
    messagingSenderId: "556775341028",
    appId: "1:556775341028:web:c7c76dd36e7f17411925f1"
  };

  // Inicializar Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Exportar para global para uso no HTML
  window.auth = auth;
  window.db = db;
  window.signInWithEmailAndPassword = signInWithEmailAndPassword;
  window.onAuthStateChanged = onAuthStateChanged;
  window.signOut = signOut;
  window.collection = collection;
  window.addDoc = addDoc;
  window.onSnapshot = onSnapshot;
  window.deleteDoc = deleteDoc;
  window.doc = doc;
</script>

<!-- Tesseract OCR -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>

<!-- jsPDF + AutoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
  /* Reset simples */
  * {
    margin: 0; padding: 0; box-sizing: border-box;
  }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f0f4f8;
    color: #222;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 10px;
  }
  h1 {
    margin: 20px 0;
    color: #1565c0;
    text-align: center;
  }
  /* Container central */
  #app {
    width: 100%;
    max-width: 900px;
  }

  /* Login */
  #loginSection {
    background: #fff;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 0 12px rgba(21, 101, 192, 0.2);
    margin-bottom: 20px;
  }
  #loginSection h2 {
    color: #1565c0;
    margin-bottom: 15px;
    text-align: center;
  }
  #loginSection input[type="email"],
  #loginSection input[type="password"] {
    width: 100%;
    padding: 10px;
    margin: 8px 0 15px;
    border: 2px solid #1565c0;
    border-radius: 6px;
    font-size: 1rem;
    outline-offset: 2px;
  }
  #loginSection button {
    width: 100%;
    background-color: #1565c0;
    color: white;
    padding: 12px;
    border: none;
    border-radius: 8px;
    font-size: 1.1rem;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  #loginSection button:hover {
    background-color: #0d47a1;
  }
  #logoutBtn {
    margin-top: 15px;
    background-color: #d32f2f;
  }
  #logoutBtn:hover {
    background-color: #9a0007;
  }
  /* Formulário de livro */
  #bookForm {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 0 15px rgb(21 101 192 / 0.15);
    margin-bottom: 30px;
  }
  #bookForm h2 {
    color: #1976d2;
    margin-bottom: 20px;
    text-align: center;
  }
  #bookForm label {
    display: block;
    margin: 10px 0 6px;
    font-weight: 600;
  }
  #bookForm input, 
  #bookForm select {
    width: 100%;
    padding: 8px 10px;
    border: 2px solid #90caf9;
    border-radius: 6px;
    font-size: 1rem;
    outline-offset: 2px;
  }
  #bookForm button {
    margin-top: 18px;
    background-color: #1976d2;
    color: white;
    padding: 12px;
    border: none;
    border-radius: 8px;
    font-size: 1.1rem;
    cursor: pointer;
    width: 100%;
    transition: background-color 0.3s ease;
  }
  #bookForm button:hover {
    background-color: #004ba0;
  }

  /* Cards listagem */
  #booksList {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(280px,1fr));
    gap: 18px;
  }
  .bookCard {
    background: linear-gradient(135deg, #42a5f5, #478ed1);
    color: white;
    padding: 20px;
    border-radius: 14px;
    box-shadow: 0 6px 12px rgb(66 165 245 / 0.5);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  .bookCard h3 {
    margin-bottom: 8px;
    font-weight: 700;
    text-shadow: 1px 1px 3px #114f8e;
  }
  .bookCard p {
    margin-bottom: 4px;
    font-size: 0.95rem;
    line-height: 1.3;
  }
  .bookCard small {
    opacity: 0.8;
  }
  .bookCard button {
    background-color: #d32f2f;
    border: none;
    border-radius: 8px;
    padding: 8px;
    margin-top: 15px;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.3s ease;
    color: white;
  }
  .bookCard button:hover {
    background-color: #9a0007;
  }

  /* Botões export */
  #exportButtons {
    display: flex;
    gap: 15px;
    margin-bottom: 30px;
  }
  #exportButtons button {
    flex: 1;
    padding: 14px;
    font-size: 1.1rem;
    font-weight: 600;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    background: linear-gradient(45deg, #1565c0, #42a5f5);
    color: white;
    transition: background 0.4s ease;
  }
  #exportButtons button:hover {
    background: linear-gradient(45deg, #0d47a1, #90caf9);
  }

  /* Loader OCR */
  #ocrStatus {
    margin-top: 10px;
    font-weight: 600;
    color: #1565c0;
    text-align: center;
  }

  /* Responsivo */
  @media(max-width: 400px){
    #bookForm button, #exportButtons button {
      font-size: 1rem;
      padding: 10px;
    }
  }
</style>
</head>
<body>

<div id="app">

  <h1>Sala de Leitura - Cadastro de Livros</h1>

  <!-- Login -->
  <section id="loginSection">
    <h2>Login</h2>
    <input id="email" type="email" placeholder="E-mail" required />
    <input id="password" type="password" placeholder="Senha" required />
    <button id="loginBtn">Entrar</button>
    <button id="logoutBtn" style="display:none;">Sair</button>
    <p id="loginMessage" style="color: red; margin-top:10px;"></p>
  </section>

  <!-- Formulário cadastro livro -->
  <section id="bookForm" style="display:none;">
    <h2>Cadastrar Livro</h2>
    <label for="title">Título</label>
    <input id="title" type="text" placeholder="Título do livro" required />

    <label for="author">Autor</label>
    <input id="author" type="text" placeholder="Autor do livro" required />

    <label for="genre">Gênero</label>
    <select id="genre" required>
      <option value="">Selecione...</option>
      <option value="Romance">Romance</option>
      <option value="Ficção Científica">Ficção Científica</option>
      <option value="Fantasia">Fantasia</option>
      <option value="Terror">Terror</option>
      <option value="Mistério">Mistério</option>
      <option value="Suspense">Suspense</option>
      <option value="Aventura">Aventura</option>
      <option value="Ficção Histórica">Ficção Histórica</option>
      <option value="Literatura Infantil">Literatura Infantil</option>
      <option value="Juvenil">Juvenil</option>
      <option value="Realismo Mágico">Realismo Mágico</option>
      <option value="Poesia">Poesia</option>
      <option value="Teatro">Teatro</option>
      <option value="Contos">Contos</option>
      <option value="Crônicas">Crônicas</option>
      <option value="Graphic Novel">Graphic Novel</option>
      <option value="Biografia">Biografia</option>
      <option value="Autobiografia">Autobiografia</option>
      <option value="Ensaios">Ensaios</option>
      <option value="História">História</option>
      <option value="Ciência">Ciência</option>
      <option value="Autoajuda">Autoajuda</option>
      <option value="Desenvolvimento Pessoal">Desenvolvimento Pessoal</option>
      <option value="Educação">Educação</option>
      <option value="Negócios">Negócios</option>
      <option value="Economia">Economia</option>
      <option value="Tecnologia">Tecnologia</option>
      <option value="Programação">Programação</option>
      <option value="Saúde">Saúde</option>
      <option value="Bem-Estar">Bem-Estar</option>
      <option value="Psicologia">Psicologia</option>
      <option value="Religião">Religião</option>
      <option value="Espiritualidade">Espiritualidade</option>
      <option value="Arte">Arte</option>
      <option value="Cultura">Cultura</option>
      <option value="Música">Música</option>
      <option value="Cinema">Cinema</option>
      <option value="Fotografia">Fotografia</option>
      <option value="Viagem">Viagem</option>
      <option value="Culinária">Culinária</option>
      <option value="Direito">Direito</option>
      <option value="Política">Política</option>
      <option value="Manuais Técnicos">Manuais Técnicos</option>
      <option value="Dicionários">Dicionários</option>
      <option value="Enciclopédias">Enciclopédias</option>
      <option value="Livros de Colorir">Livros de Colorir</option>
      <option value="Planners">Planners</option>
      <option value="Livros Interativos">Livros Interativos</option>
      <option value="Quebra-Cabeças">Quebra-Cabeças</option>
      <option value="Livros-Objeto">Livros-Objeto</option>
    </select>

    <label for="publisher">Editora</label>
    <input id="publisher" type="text" placeholder="Editora" />

    <label for="year">Ano</label>
    <input id="year" type="number" placeholder="Ano de publicação" min="1500" max="2099" />

    <label for="copies">Exemplares</label>
    <input id="copies" type="number" placeholder="Quantidade de exemplares" min="1" value="1" />

    <label for="coverImage">Capa (imagem para OCR)</label>
    <input id="coverImage" type="file" accept="image/*" />

    <div id="ocrStatus"></div>

    <button id="addBookBtn">Adicionar Livro</button>
  </section>

  <!-- Botões exportação -->
  <div id="exportButtons" style="display:none;">
    <button id="exportCSVBtn">Exportar CSV</button>
    <button id="exportPDFBtn">Gerar PDF</button>
  </div>

  <!-- Listagem -->
  <section id="booksList"></section>

</div>

<script type="module">
  import { jsPDF } from "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js";
  import "https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js";

  const auth = window.auth;
  const db = window.db;
  const signInWithEmailAndPassword = window.signInWithEmailAndPassword;
  const onAuthStateChanged = window.onAuthStateChanged;
  const signOut = window.signOut;
  const collection = window.collection;
  const addDoc = window.addDoc;
  const onSnapshot = window.onSnapshot;
  const deleteDoc = window.deleteDoc;
  const docFunc = window.doc;

  const loginSection = document.getElementById('loginSection');
  const bookForm = document.getElementById('bookForm');
  const booksList = document.getElementById('booksList');
  const exportButtons = document.getElementById('exportButtons');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const loginMessage = document.getElementById('loginMessage');

  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');

  const titleInput = document.getElementById('title');
  const authorInput = document.getElementById('author');
  const genreSelect = document.getElementById('genre');
  const publisherInput = document.getElementById('publisher');
  const yearInput = document.getElementById('year');
  const copiesInput = document.getElementById('copies');
  const coverImageInput = document.getElementById('coverImage');
  const ocrStatus = document.getElementById('ocrStatus');

  const addBookBtn = document.getElementById('addBookBtn');
  const exportCSVBtn = document.getElementById('exportCSVBtn');
  const exportPDFBtn = document.getElementById('exportPDFBtn');

  // Coleção Firestore
  const booksCollection = collection(db, "books");

  // Cache local para livros
  let localBooksCache = [];

  // Login
  loginBtn.addEventListener('click', () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    loginMessage.textContent = "";
    if (!email || !password) {
      loginMessage.textContent = "Informe email e senha.";
      return;
    }
    signInWithEmailAndPassword(auth, email, password)
      .then(() => {
        // Sucesso, auth state vai mudar e exibir conteúdo
      })
      .catch((error) => {
        loginMessage.textContent = "Erro: " + error.message;
      });
  });

  logoutBtn.addEventListener('click', () => {
    signOut(auth);
  });

  // Monitorar login
  onAuthStateChanged(auth, (user) => {
    if (user) {
      loginSection.style.display = "none";
      bookForm.style.display = "block";
      exportButtons.style.display = "flex";
      loadBooksRealtime();
    } else {
      loginSection.style.display = "block";
      bookForm.style.display = "none";
      exportButtons.style.display = "none";
      booksList.innerHTML = "";
    }
  });

  // Função para carregar livros em tempo real e atualizar cache
  function loadBooksRealtime() {
    onSnapshot(booksCollection, (snapshot) => {
      localBooksCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderBooks(localBooksCache);
    }, (error) => {
      console.error("Erro ao carregar livros:", error);
    });
  }

  // Renderizar livros na tela
  function renderBooks(books) {
    booksList.innerHTML = "";
    if (books.length === 0) {
      booksList.innerHTML = "<p>Nenhum livro cadastrado.</p>";
      return;
    }
    books.forEach(book => {
      const card = document.createElement('article');
      card.className = 'bookCard';
      card.innerHTML = `
        <h3>${book.title}</h3>
        <p><strong>Autor:</strong> ${book.author}</p>
        <p><strong>Gênero:</strong> ${book.genre}</p>
        <p><strong>Editora:</strong> ${book.publisher || '-'}</p>
        <p><strong>Ano:</strong> ${book.year || '-'}</p>
        <p><strong>Exemplares:</strong> ${book.copies || 1}</p>
        <button data-id="${book.id}">Excluir</button>
      `;
      const delBtn = card.querySelector('button');
      delBtn.onclick = async () => {
        if (confirm(`Excluir o livro "${book.title}"?`)) {
          try {
            await deleteDoc(docFunc(db, "books", book.id));
          } catch (err) {
            alert("Erro ao excluir livro: " + err.message);
          }
        }
      };
      booksList.appendChild(card);
    });
  }

  // Adicionar livro no Firestore
  addBookBtn.addEventListener('click', async () => {
    const title = titleInput.value.trim();
    const author = authorInput.value.trim();
    const genre = genreSelect.value;
    const publisher = publisherInput.value.trim();
    const year = parseInt(yearInput.value);
    const copies = parseInt(copiesInput.value);

    if (!title || !author || !genre) {
      alert("Preencha título, autor e gênero.");
      return;
    }

    try {
      await addDoc(booksCollection, {
        title,
        author,
        genre,
        publisher: publisher || null,
        year: isNaN(year) ? null : year,
        copies: isNaN(copies) || copies < 1 ? 1 : copies
      });

      // Limpar form
      titleInput.value = "";
      authorInput.value = "";
      genreSelect.value = "";
      publisherInput.value = "";
      yearInput.value = "";
      copiesInput.value = "1";
      coverImageInput.value = "";
      ocrStatus.textContent = "";

      alert("Livro adicionado com sucesso!");
    } catch (err) {
      alert("Erro ao adicionar livro: " + err.message);
    }
  });

  // OCR da imagem da capa para preencher título e autor automaticamente
  coverImageInput.addEventListener('change', () => {
    const file = coverImageInput.files[0];
    if (!file) return;
    ocrStatus.textContent = "Analisando imagem para capturar texto...";

    Tesseract.recognize(
      file,
      'por',
      { logger: m => {
        // Opcional: console.log(m);
      } }
    ).then(({ data: { text } }) => {
      ocrStatus.textContent = "OCR concluído. Verifique e corrija os campos.";
      // Simples heurística: tenta separar linhas e pegar título e autor das primeiras linhas
      const lines = text.split('\n').map(l => l.trim()).filter(l => l);
      if (lines.length > 0) titleInput.value = lines[0];
      if (lines.length > 1) authorInput.value = lines[1];
    }).catch((e) => {
      ocrStatus.textContent = "Erro no OCR: " + e.message;
    });
  });

  // Exportar CSV
  exportCSVBtn.addEventListener('click', () => {
    if (localBooksCache.length === 0) {
      alert("Não há livros para exportar.");
      return;
    }
    const csvRows = [];
    csvRows.push(['Título','Autor','Gênero','Editora','Ano','Exemplares'].join(';'));
    localBooksCache.forEach(b => {
      csvRows.push([
        b.title || '',
        b.author || '',
        b.genre || '',
        b.publisher || '',
        b.year || '',
        b.copies || ''
      ].join(';'));
    });
    const csvContent = '\uFEFF' + csvRows.join('\n'); // BOM para Excel
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `livros_sala_leitura_${new Date().toLocaleDateString('pt-BR').replace(/\//g,'-')}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  });

  // Exportar PDF
  exportPDFBtn.addEventListener('click', () => {
    if (localBooksCache.length === 0) {
      alert("Não há livros para gerar relatório.");
      return;
    }
    const doc = new jsPDF();
    const date = new Date().toLocaleDateString('pt-BR');
    doc.setFontSize(18);
    doc.text("Sala de Leitura - Relatório de Livros", 14, 20);
    doc.setFontSize(11);
    doc.text(`Gerado em: ${date}`, 14, 30);

    const tableData = localBooksCache.map(b => [
      b.title || '',
      b.author || '',
      b.genre || '',
      b.publisher || '',
      b.year ? b.year.toString() : '',
      b.copies ? b.copies.toString() : ''
    ]);

    doc.autoTable({
      head: [['Título', 'Autor', 'Gênero', 'Editora', 'Ano', 'Exemplares']],
      body: tableData,
      startY: 40,
      styles: { fontSize: 8 }
    });

    doc.save(`relatorio_livros_${date}.pdf`);
  });
</script>

</body>
</html>
