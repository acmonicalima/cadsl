<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sala de Leitura | JOÃO VITTA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script type="module">
      // Import do Firebase (v9 modular)
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
      import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

      // Sua configuração
      const firebaseConfig = {
        apiKey: "AIzaSyC72gBi7POz-NqEMWKgu54S9vTyr0oFkzs",
        authDomain: "cadsl-3ef8f.firebaseapp.com",
        projectId: "cadsl-3ef8f",
        storageBucket: "cadsl-3ef8f.firebasestorage.app",
        messagingSenderId: "556775341028",
        appId: "1:556775341028:web:c7c76dd36e7f17411925f1"
      };

      // Inicializa
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const dbFirestore = getFirestore(app);

      // Exporta globalmente
      window.firebase = { auth, dbFirestore, signInWithEmailAndPassword, signOut, collection, addDoc, onSnapshot };
    </script>
    <!-- Bibliotecas para PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <!-- Tesseract para OCR -->
    <script src="https://unpkg.com/tesseract.js@v5.0.0/dist/tesseract.min.js"></script>
    <style>
        :root {
            --primary: #4a6fa5;
            --light: #f8f9fa;
            --danger: #dc3545;
            --warning: #ffc107;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', sans-serif;
        }
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, #4a6fa5, #166088);
        }
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            width: 100%;
            max-width: 400px;
            color: #333;
        }
        .login-box h2 {
            margin-bottom: 20px;
            color: var(--primary);
        }
        .login-box input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        .btn-primary {
            background-color: var(--primary);
            color: white;
            width: 100%;
        }
        .btn-danger {
            background-color: var(--danger);
            color: white;
            width: 100%;
        }
        .app-container {
            display: none;
            padding: 20px;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .table th {
            background-color: #f8f9fa;
        }
        .book-cover {
            width: 60px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
        }
        .btn-warning {
            background-color: var(--warning);
            color: #000;
        }
    </style>
</head>
<body>

  <!-- Tela de Login -->
  <div id="login-container" class="login-container">
    <div class="login-box">
      <h2><i class="fas fa-book"></i> Sala de Leitura</h2>
      <p><strong>JOÃO VITTA</strong></p>
      <input type="email" id="email" placeholder="E-mail" class="form-control">
      <input type="password" id="password" placeholder="Senha" class="form-control">
      <button onclick="login()" class="btn btn-primary">Entrar</button>
      <p style="color: #666; margin-top: 10px; font-size: 14px;">
        Use: adrianarruda@gmail.com ou monicalima@gmail.com
      </p>
    </div>
  </div>

  <!-- App Principal -->
  <div id="app-container" class="app-container">

    <header style="background: var(--primary); color: white; padding: 15px; text-align: center; border-radius: 8px; margin-bottom: 20px;">
      <h1><i class="fas fa-book"></i> Sala de Leitura | JOÃO VITTA</h1>
      <button onclick="logout()" class="btn btn-danger" style="float: right;">Sair</button>
    </header>

    <div class="card">
      <h2><i class="fas fa-book"></i> Cadastrar Novo Livro</h2>
      <form id="bookForm">
        <div class="form-group">
          <label>Título:</label>
          <input type="text" id="title" class="form-control" required>
        </div>
        <div class="form-group">
          <label>Autor:</label>
          <input type="text" id="author" class="form-control" required>
        </div>
        <div class="form-group">
          <label>Gênero:</label>
          <select id="genre" class="form-control" required>
            <option value="">Selecione...</option>
            <option value="Literatura">Literatura</option>
            <option value="Ficção">Ficção</option>
            <option value="Não Ficção">Não Ficção</option>
            <option value="Infantil">Infantil</option>
            <option value="Educacional">Educacional</option>
          </select>
        </div>
        <div class="form-group">
          <label>Capa do Livro:</label>
          <input type="file" id="cover" accept="image/*" class="form-control">
          <div id="coverPreview" style="margin-top: 10px;"></div>
        </div>
        <button type="button" class="btn btn-primary" onclick="preencherComImagem()">
          <i class="fas fa-image"></i> Preencher com Imagem
        </button>
        <button type="submit" class="btn btn-primary" style="margin-top: 10px;">
          <i class="fas fa-save"></i> Salvar Livro
        </button>
        <button type="button" class="btn btn-warning" onclick="limparFormulario()" style="margin-left: 10px;">
          <i class="fas fa-eraser"></i> Limpar
        </button>
      </form>
    </div>

    <div class="card">
      <h2>Livros Cadastrados</h2>
      <table class="table" id="booksTable">
        <thead>
          <tr>
            <th>Capa</th>
            <th>Título</th>
            <th>Autor</th>
            <th>Gênero</th>
          </tr>
        </thead>
        <tbody id="booksList"></tbody>
      </table>
    </div>

    <div class="card">
      <button onclick="gerarPDF()" class="btn btn-primary">
        <i class="fas fa-file-pdf"></i> Gerar Relatório em PDF
      </button>
      <button onclick="exportarCSV()" class="btn btn-success" style="margin-left: 10px;">
        <i class="fas fa-file-export"></i> Exportar CSV
      </button>
    </div>

  </div>

  <script>
    // Banco local
    const db = { books: [] };

    // Verifica login
    function verificarLogin() {
      const loginContainer = document.getElementById('login-container');
      const appContainer = document.getElementById('app-container');

      window.firebase.auth.onAuthStateChanged((user) => {
        if (user) {
          loginContainer.style.display = 'none';
          appContainer.style.display = 'block';
          carregarLivros();
        } else {
          loginContainer.style.display = 'flex';
          appContainer.style.display = 'none';
        }
      });
    }

    // Login
    function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      window.firebase.signInWithEmailAndPassword(window.firebase.auth, email, password)
        .then(() => alert('Login feito com sucesso!'))
        .catch(err => alert('Erro: ' + err.message));
    }

    // Logout
    function logout() {
      window.firebase.signOut(window.firebase.auth)
        .then(() => alert('Saiu com sucesso!'));
    }

    // Carregar livros do Firestore
    function carregarLivros() {
      window.firebase.onSnapshot(window.firebase.collection(window.firebase.dbFirestore, 'livros'), (snapshot) => {
        db.books = [];
        snapshot.forEach(doc => db.books.push({ id: doc.id, ...doc.data() }));
        atualizarLista();
      });
    }

    // Atualizar lista
    function atualizarLista() {
      const list = document.getElementById('booksList');
      list.innerHTML = '';
      db.books.forEach(book => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><img src="${book.coverImage || 'https://via.placeholder.com/60x80'}" class="book-cover"></td>
          <td>${book.title}</td>
          <td>${book.author}</td>
          <td>${book.genre}</td>
        `;
        list.appendChild(row);
      });
    }

    // Salvar livro
    document.getElementById('bookForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const file = document.getElementById('cover').files[0];
      let coverImage = null;
      if (file) coverImage = URL.createObjectURL(file);

      const livro = {
        title: document.getElementById('title').value,
        author: document.getElementById('author').value,
        genre: document.getElementById('genre').value,
        coverImage
      };

      await window.firebase.addDoc(window.firebase.collection(window.firebase.dbFirestore, 'livros'), livro);
      document.getElementById('bookForm').reset();
      document.getElementById('coverPreview').innerHTML = '';
    });

    // Pré-visualização da capa
    document.getElementById('cover').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = ev => {
          document.getElementById('coverPreview').innerHTML = `
            <img src="${ev.target.result}" style="max-width: 100px; margin-top: 10px;">
          `;
        };
        reader.readAsDataURL(file);
      }
    });

    // Limpar formulário
    function limparFormulario() {
      document.getElementById('bookForm').reset();
      document.getElementById('coverPreview').innerHTML = '';
      document.getElementById('cover').value = '';
    }

    // OCR com imagem
    async function preencherComImagem() {
      const file = document.getElementById('cover').files[0];
      if (!file) return alert('Selecione uma imagem');
      try {
        const result = await Tesseract.recognize(file, 'por+eng');
        const text = result.data.text;
        document.getElementById('title').value = text.split('\n')[0]?.trim() || '';
      } catch (err) {
        alert('Erro no OCR');
      }
    }

    // Exportar CSV
    function exportarCSV() {
      const csv = [
        ['Título', 'Autor', 'Gênero'].join(';'),
        ...db.books.map(b => [b.title, b.author, b.genre].join(';'))
      ].join('\n');
      const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'livros.csv';
      a.click();
    }

    // Gerar PDF
    function gerarPDF() {
      const doc = new jspdf.jsPDF();
      doc.text("Relatório de Livros", 14, 20);
      const tableData = db.books.map(b => [b.title, b.author, b.genre]);
      doc.autoTable({
        head: [['Título', 'Autor', 'Gênero']],
        body: tableData,
        startY: 30
      });
      doc.save('relatorio_livros.pdf');
    }

    // Inicializar
    document.addEventListener('DOMContentLoaded', verificarLogin);
  </script>
</body>
</html>
