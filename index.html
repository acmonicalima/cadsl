<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sala de Leitura | JOÃO VITTA</title>
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    rel="stylesheet"
  />
  <!-- PDF libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <!-- Tesseract OCR -->
  <script src="https://unpkg.com/tesseract.js@v5.0.0/dist/tesseract.min.js"></script>

  <style>
    /* Variáveis de cor vibrantes */
    :root {
      --color-primary: #2962ff;
      --color-primary-dark: #0039cb;
      --color-secondary: #ff6d00;
      --color-secondary-dark: #b53d00;
      --color-success: #2e7d32;
      --color-error: #d32f2f;
      --color-bg: #f0f4ff;
      --color-text: #212121;
      --color-white: #fff;
      --border-radius: 8px;
      --transition: 0.3s ease;
    }

    /* Reset básico */
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--color-bg);
      color: var(--color-text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: var(--color-primary);
      color: var(--color-white);
      padding: 20px 30px;
      box-shadow: 0 4px 8px rgb(0 0 0 / 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 15px;
    }

    header h1 {
      font-weight: 700;
      font-size: 1.8rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    nav button {
      background: transparent;
      border: none;
      color: var(--color-white);
      font-size: 1rem;
      cursor: pointer;
      padding: 8px 15px;
      border-radius: var(--border-radius);
      transition: background-color var(--transition);
    }

    nav button.active,
    nav button:hover {
      background-color: var(--color-primary-dark);
      font-weight: 700;
    }

    main {
      flex-grow: 1;
      max-width: 1200px;
      margin: 30px auto;
      padding: 0 15px 40px;
      width: 100%;
    }

    /* Cards */
    .card {
      background: var(--color-white);
      border-radius: var(--border-radius);
      box-shadow: 0 2px 10px rgb(0 0 0 / 0.1);
      padding: 25px 30px;
      margin-bottom: 30px;
      transition: box-shadow var(--transition);
    }

    .card:hover {
      box-shadow: 0 4px 16px rgb(0 0 0 / 0.15);
    }

    h2 {
      margin-bottom: 20px;
      font-weight: 700;
      font-size: 1.5rem;
      color: var(--color-primary-dark);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Form */
    form {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }

    .form-group {
      flex: 1 1 250px;
      display: flex;
      flex-direction: column;
    }

    label {
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--color-primary-dark);
    }

    input[type='text'],
    input[type='email'],
    input[type='password'],
    input[type='number'],
    select,
    input[type='file'] {
      padding: 10px 14px;
      font-size: 1rem;
      border: 2px solid #ddd;
      border-radius: var(--border-radius);
      transition: border-color var(--transition);
    }

    input[type='text']:focus,
    input[type='email']:focus,
    input[type='password']:focus,
    input[type='number']:focus,
    select:focus,
    input[type='file']:focus {
      outline: none;
      border-color: var(--color-primary);
    }

    /* Buttons */
    button {
      padding: 12px 25px;
      font-weight: 700;
      font-size: 1rem;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: background-color var(--transition);
      color: var(--color-white);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-primary {
      background-color: var(--color-primary);
    }
    .btn-primary:hover:not(:disabled) {
      background-color: var(--color-primary-dark);
    }

    .btn-secondary {
      background-color: var(--color-secondary);
    }
    .btn-secondary:hover:not(:disabled) {
      background-color: var(--color-secondary-dark);
    }

    .btn-success {
      background-color: var(--color-success);
    }
    .btn-success:hover:not(:disabled) {
      background-color: #256028;
    }

    .btn-error {
      background-color: var(--color-error);
    }
    .btn-error:hover:not(:disabled) {
      background-color: #b71c1c;
    }

    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      padding: 12px 15px;
      border-bottom: 1px solid #ddd;
      text-align: left;
      vertical-align: middle;
    }

    th {
      background-color: var(--color-primary);
      color: var(--color-white);
      font-weight: 700;
    }

    tr:hover {
      background-color: #f0f7ff;
    }

    /* Book cover images */
    .book-cover {
      width: 70px;
      height: 90px;
      object-fit: cover;
      border-radius: 6px;
      box-shadow: 0 1px 5px rgb(0 0 0 / 0.1);
    }

    /* Status badge */
    .status-badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.9rem;
      display: inline-block;
      min-width: 80px;
      text-align: center;
    }

    .status-available {
      background-color: #c8e6c9;
      color: #256028;
    }

    .status-unavailable {
      background-color: #ffcdd2;
      color: #c62828;
    }

    /* Search input and button */
    .search-container {
      display: flex;
      gap: 12px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .search-container input[type='text'] {
      flex-grow: 1;
      min-width: 250px;
    }

    /* Flex container for form rows */
    .flex-row {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }

    /* Login screen */
    #login-screen {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: var(--color-bg);
      padding: 20px;
    }

    #login-screen .login-box {
      background: var(--color-white);
      padding: 30px 40px;
      border-radius: var(--border-radius);
      box-shadow: 0 4px 16px rgb(0 0 0 / 0.1);
      width: 100%;
      max-width: 380px;
      text-align: center;
    }

    #login-screen h2 {
      margin-bottom: 20px;
      font-weight: 700;
      color: var(--color-primary);
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
      border-bottom: 2px solid #ddd;
      flex-wrap: wrap;
    }

    .tab {
      padding: 12px 25px;
      cursor: pointer;
      border-bottom: 4px solid transparent;
      font-weight: 600;
      color: var(--color-primary-dark);
      transition: border-color var(--transition);
    }

    .tab.active {
      border-color: var(--color-primary);
      color: var(--color-primary-dark);
    }

    /* Offline notification */
    #offlineNotification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: var(--color-secondary);
      color: var(--color-white);
      padding: 12px 20px;
      border-radius: var(--border-radius);
      box-shadow: 0 4px 15px rgb(0 0 0 / 0.2);
      display: none;
      z-index: 9999;
    }

    /* Action buttons inside table */
    .action-buttons {
      display: flex;
      gap: 8px;
    }

    .action-btn {
      border: none;
      cursor: pointer;
      border-radius: var(--border-radius);
      padding: 6px 10px;
      color: var(--color-white);
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: background-color var(--transition);
    }

    .action-btn.delete {
      background-color: var(--color-error);
    }

    .action-btn.delete:hover {
      background-color: #b71c1c;
    }

    /* Cover preview */
    #coverPreview img {
      max-width: 110px;
      max-height: 130px;
      margin-top: 12px;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 10px rgb(0 0 0 / 0.1);
    }
  </style>

  <!-- Firebase Module Import -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      signOut,
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      onSnapshot,
      deleteDoc,
      doc,
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC72gBi7POz-NqEMWKgu54S9vTyr0oFkzs",
      authDomain: "cadsl-3ef8f.firebaseapp.com",
      projectId: "cadsl-3ef8f",
      storageBucket: "cadsl-3ef8f.firebasestorage.app",
      messagingSenderId: "556775341028",
      appId: "1:556775341028:web:c7c76dd36e7f17411925f1",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    window.myFirebase = {
      auth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      signOut,
      db,
      collection,
      addDoc,
      onSnapshot,
      deleteDoc,
      doc,
    };
  </script>
</head>

<body>
  <!-- Tela Login -->
  <section id="login-screen" aria-label="Tela de login">
    <div class="login-box" role="main">
      <h2><i class="fas fa-book"></i> Sala de Leitura - JOÃO VITTA</h2>
      <input
        type="email"
        id="email"
        placeholder="Digite seu e-mail"
        autocomplete="username"
        required
        aria-label="Campo e-mail"
      />
      <input
        type="password"
        id="password"
        placeholder="Digite sua senha"
        autocomplete="current-password"
        required
        aria-label="Campo senha"
      />
      <button class="btn-primary" id="loginBtn" aria-label="Entrar no sistema">
        <i class="fas fa-sign-in-alt"></i> Entrar
      </button>
    </div>
  </section>

  <!-- App Principal -->
  <main id="main-app" style="display:none" aria-label="Aplicação principal">
    <header>
      <h1><i class="fas fa-book"></i> Sala de Leitura | JOÃO VITTA</h1>
      <nav aria-label="Navegação principal">
        <button class="tab active" data-tab="books" aria-selected="true" role="tab">
          <i class="fas fa-book"></i> Livros
        </button>
        <button class="tab" data-tab="reports" aria-selected="false" role="tab">
          <i class="fas fa-chart-bar"></i> Relatórios
        </button>
        <button class="tab" data-tab="settings" aria-selected="false" role="tab">
          <i class="fas fa-cog"></i> Configurações
        </button>
        <button id="logoutBtn" class="btn-secondary" aria-label="Sair do sistema" style="margin-left: auto">
          <i class="fas fa-sign-out-alt"></i> Sair
        </button>
      </nav>
    </header>

    <section id="books" class="tab-content active" role="tabpanel" aria-hidden="false">
      <div class="card">
        <h2><i class="fas fa-plus-circle"></i> Cadastrar Novo Livro</h2>
        <form id="bookForm" autocomplete="off" novalidate>
          <div class="flex-row">
            <div class="form-group">
              <label for="title">Título *</label>
              <input type="text" id="title" required aria-required="true" />
            </div>
            <div class="form-group">
              <label for="author">Autor *</label>
              <input type="text" id="author" required aria-required="true" />
            </div>
          </div>
          <div class="flex-row">
            <div class="form-group">
              <label for="genre">Gênero *</label>
              <select id="genre" required aria-required="true">
                <option value="">Selecione...</option>
                <option value="Literatura">Literatura</option>
                <option value="Ficção">Ficção</option>
                <option value="Não Ficção">Não Ficção</option>
                <option value="Infantil">Infantil</option>
                <option value="Educacional">Educacional</option>
                <option value="Biografia">Biografia</option>
              </select>
            </div>
            <div class="form-group">
              <label for="publisher">Editora *</label>
              <input type="text" id="publisher" required aria-required="true" />
            </div>
          </div>
          <div class="flex-row">
            <div class="form-group">
              <label for="year">Ano *</label>
              <input type="number" id="year" min="1900" max="2099" required aria-required="true" />
            </div>
            <div class="form-group">
              <label for="copies">Exemplares *</label>
              <input type="number" id="copies" min="1" required aria-required="true" />
            </div>
          </div>
          <div class="form-group" style="flex:1 1 100%;">
            <label for="cover">Capa do Livro</label>
            <input type="file" id="cover" accept="image/*" />
            <div id="coverPreview" aria-live="polite"></div>
          </div>
          <div class="flex-row" style="gap: 15px; flex-wrap: nowrap;">
            <button type="button" class="btn-primary" id="extractFromImageBtn" aria-label="Extrair título e autor da imagem">
              <i class="fas fa-image"></i> Preencher com Imagem
            </button>
            <button type="submit" class="btn-success" aria-label="Salvar livro">
              <i class="fas fa-save"></i> Salvar Livro
            </button>
            <button type="button" class="btn-secondary" id="clearFormBtn" aria-label="Limpar formulário">
              <i class="fas fa-eraser"></i> Limpar Formulário
            </button>
          </div>
        </form>
      </div>

      <div class="card">
        <h2><i class="fas fa-list"></i> Lista de Livros</h2>
        <div class="search-container">
          <input
            type="text"
            id="searchBooks"
            placeholder="Buscar por título ou autor..."
            aria-label="Buscar livros"
          />
          <button id="searchBtn" class="btn-primary" aria-label="Buscar livros">
            <i class="fas fa-search"></i> Buscar
          </button>
        </div>
        <table aria-label="Lista de livros" role="grid">
          <thead>
            <tr>
              <th>Capa</th>
              <th>Título</th>
              <th>Autor</th>
              <th>Gênero</th>
              <th>Editora</th>
              <th>Ano</th>
              <th>Exemplares</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="booksList"></tbody>
        </table>
      </div>

      <div class="card">
        <h2><i class="fas fa-file-export"></i> Exportar Dados</h2>
        <button id="exportPdfBtn" class="btn-primary" aria-label="Exportar lista em PDF">
          <i class="fas fa-file-pdf"></i> Exportar PDF
        </button>
        <button id="exportCsvBtn" class="btn-secondary" aria-label="Exportar lista em CSV">
          <i class="fas fa-file-csv"></i> Exportar CSV
        </button>
      </div>
    </section>

    <section id="reports" class="tab-content" role="tabpanel" aria-hidden="true">
      <div class="card">
        <h2><i class="fas fa-chart-bar"></i> Relatórios</h2>
        <p>Em breve, funcionalidades de relatórios avançados.</p>
      </div>
    </section>

    <section id="settings" class="tab-content" role="tabpanel" aria-hidden="true">
      <div class="card">
        <h2><i class="fas fa-cog"></i> Configurações</h2>
        <p>Configurações do sistema em desenvolvimento.</p>
      </div>
    </section>
  </main>

  <div id="offlineNotification" role="alert" aria-live="assertive"></div>

  <script>
    // Esperar carregar tudo
    document.addEventListener("DOMContentLoaded", () => {
      const {
        auth,
        onAuthStateChanged,
        signInWithEmailAndPassword,
        signOut,
        db,
        collection,
        addDoc,
        onSnapshot,
        deleteDoc,
        doc,
      } = window.myFirebase;

      // --- LOGIN ---
      const loginScreen = document.getElementById("login-screen");
      const mainApp = document.getElementById("main-app");
      const loginBtn = document.getElementById("loginBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      const emailInput = document.getElementById("email");
      const passwordInput = document.getElementById("password");

      loginBtn.addEventListener("click", async () => {
        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();
        if (!email || !password) {
          alert("Preencha e-mail e senha.");
          return;
        }
        try {
          await signInWithEmailAndPassword(auth, email, password);
          // sucesso
        } catch (error) {
          alert("Erro no login: " + error.message);
        }
      });

      logoutBtn.addEventListener("click", async () => {
        await signOut(auth);
      });

      onAuthStateChanged(auth, (user) => {
        if (user) {
          loginScreen.style.display = "none";
          mainApp.style.display = "flex";
          loadBooks();
        } else {
          loginScreen.style.display = "flex";
          mainApp.style.display = "none";
        }
      });

      // --- TABS ---
      const tabs = document.querySelectorAll("nav button.tab");
      const tabContents = document.querySelectorAll(".tab-content");

      tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          tabs.forEach((t) => {
            t.classList.remove("active");
            t.setAttribute("aria-selected", "false");
          });
          tab.classList.add("active");
          tab.setAttribute("aria-selected", "true");

          const target = tab.dataset.tab;
          tabContents.forEach((content) => {
            if (content.id === target) {
              content.classList.add("active");
              content.setAttribute("aria-hidden", "false");
            } else {
              content.classList.remove("active");
              content.setAttribute("aria-hidden", "true");
            }
          });
        });
      });

      // --- FORMULÁRIO DE LIVRO ---
      const bookForm = document.getElementById("bookForm");
      const titleInput = document.getElementById("title");
      const authorInput = document.getElementById("author");
      const genreSelect = document.getElementById("genre");
      const publisherInput = document.getElementById("publisher");
      const yearInput = document.getElementById("year");
      const copiesInput = document.getElementById("copies");
      const coverInput = document.getElementById("cover");
      const coverPreview = document.getElementById("coverPreview");
      const extractBtn = document.getElementById("extractFromImageBtn");
      const clearFormBtn = document.getElementById("clearFormBtn");
      let coverDataUrl = "";

      // Mostrar preview da capa ao selecionar imagem
      coverInput.addEventListener("change", () => {
        const file = coverInput.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            coverDataUrl = e.target.result;
            coverPreview.innerHTML = `<img src="${coverDataUrl}" alt="Capa do livro" />`;
          };
          reader.readAsDataURL(file);
        } else {
          coverPreview.innerHTML = "";
          coverDataUrl = "";
        }
      });

      // Extrair título e autor da imagem usando Tesseract
      extractBtn.addEventListener("click", async () => {
        if (!coverDataUrl) {
          alert("Selecione uma imagem da capa antes de extrair.");
          return;
        }
        extractBtn.disabled = true;
        extractBtn.textContent = "Extraindo...";
        try {
          const worker = Tesseract.createWorker({
            logger: (m) => console.log(m),
          });
          await worker.load();
          await worker.loadLanguage("por");
          await worker.initialize("por");
          const {
            data: { text },
          } = await worker.recognize(coverDataUrl);
          await worker.terminate();
          // Tentativa simples: pegar as primeiras linhas e colocar no título e autor
          const lines = text
            .split("\n")
            .map((l) => l.trim())
            .filter((l) => l.length > 3);
          if (lines.length >= 2) {
            titleInput.value = lines[0];
            authorInput.value = lines[1];
          } else if (lines.length === 1) {
            titleInput.value = lines[0];
          } else {
            alert("Não foi possível extrair texto útil da imagem.");
          }
        } catch (e) {
          alert("Erro ao extrair texto: " + e.message);
        } finally {
          extractBtn.disabled = false;
          extractBtn.innerHTML = '<i class="fas fa-image"></i> Preencher com Imagem';
        }
      });

      clearFormBtn.addEventListener("click", () => {
        bookForm.reset();
        coverPreview.innerHTML = "";
        coverDataUrl = "";
      });

      // --- Firestore coleção ---
      const booksCollection = collection(db, "books");

      // Adicionar livro
      bookForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Validações simples
        if (
          !titleInput.value.trim() ||
          !authorInput.value.trim() ||
          !genreSelect.value ||
          !publisherInput.value.trim() ||
          !yearInput.value ||
          !copiesInput.value
        ) {
          alert("Por favor, preencha todos os campos obrigatórios.");
          return;
        }

        try {
          await addDoc(booksCollection, {
            title: titleInput.value.trim(),
            author: authorInput.value.trim(),
            genre: genreSelect.value,
            publisher: publisherInput.value.trim(),
            year: parseInt(yearInput.value, 10),
            copies: parseInt(copiesInput.value, 10),
            cover: coverDataUrl || null,
            createdAt: new Date(),
          });
          bookForm.reset();
          coverPreview.innerHTML = "";
          coverDataUrl = "";
          alert("Livro salvo com sucesso!");
        } catch (error) {
          alert("Erro ao salvar livro: " + error.message);
        }
      });

      // --- Listagem dinâmica ---
      const booksList = document.getElementById("booksList");

      function renderBooks(docs) {
        booksList.innerHTML = "";
        if (docs.length === 0) {
          booksList.innerHTML = `<tr><td colspan="8" style="text-align:center; color:#999;">Nenhum livro cadastrado.</td></tr>`;
          return;
        }
        docs.forEach((doc) => {
          const book = doc.data();
          const tr = document.createElement("tr");

          // Capa
          const tdCover = document.createElement("td");
          if (book.cover) {
            const img = document.createElement("img");
            img.src = book.cover;
            img.alt = `Capa do livro ${book.title}`;
            img.className = "book-cover";
            tdCover.appendChild(img);
          } else {
            tdCover.textContent = "-";
          }
          tr.appendChild(tdCover);

          // Título
          const tdTitle = document.createElement("td");
          tdTitle.textContent = book.title;
          tr.appendChild(tdTitle);

          // Autor
          const tdAuthor = document.createElement("td");
          tdAuthor.textContent = book.author;
          tr.appendChild(tdAuthor);

          // Gênero
          const tdGenre = document.createElement("td");
          tdGenre.textContent = book.genre;
          tr.appendChild(tdGenre);

          // Editora
          const tdPublisher = document.createElement("td");
          tdPublisher.textContent = book.publisher;
          tr.appendChild(tdPublisher);

          // Ano
          const tdYear = document.createElement("td");
          tdYear.textContent = book.year;
          tr.appendChild(tdYear);

          // Exemplares
          const tdCopies = document.createElement("td");
          tdCopies.textContent = book.copies;
          tr.appendChild(tdCopies);

          // Ações
          const tdActions = document.createElement("td");
          const btnDelete = document.createElement("button");
          btnDelete.className = "action-btn delete";
          btnDelete.title = "Excluir livro";
          btnDelete.setAttribute("aria-label", `Excluir livro ${book.title}`);
          btnDelete.innerHTML = '<i class="fas fa-trash"></i>';
          btnDelete.addEventListener("click", async () => {
            if (
              confirm(
                `Deseja realmente excluir o livro "${book.title}"? Esta ação não pode ser desfeita.`
              )
            ) {
              await deleteDoc(doc(db, "books", doc.id));
            }
          });
          tdActions.appendChild(btnDelete);
          tr.appendChild(tdActions);

          booksList.appendChild(tr);
        });
      }

      // Ouvir a coleção em tempo real
      onSnapshot(booksCollection, (snapshot) => {
        const docs = snapshot.docs;
        renderBooks(docs);
      });

      // --- Busca ---
      const searchInput = document.getElementById("searchBooks");
      const searchBtn = document.getElementById("searchBtn");

      function filterBooks() {
        const query = searchInput.value.trim().toLowerCase();
        const rows = booksList.querySelectorAll("tr");
        rows.forEach((row) => {
          const title = row.children[1]?.textContent.toLowerCase() || "";
          const author = row.children[2]?.textContent.toLowerCase() || "";
          if (title.includes(query) || author.includes(query)) {
            row.style.display = "";
          } else {
            row.style.display = "none";
          }
        });
      }

      searchBtn.addEventListener("click", filterBooks);
      searchInput.addEventListener("input", filterBooks);

      // --- Exportar PDF ---
      const exportPdfBtn = document.getElementById("exportPdfBtn");
      exportPdfBtn.addEventListener("click", () => {
        import("https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js").then(({ jsPDF }) => {
          const doc = new jsPDF.jsPDF();
          doc.setFontSize(16);
          doc.text("Lista de Livros - Sala de Leitura", 14, 20);

          const rows = [];
          const headers = [
            "Título",
            "Autor",
            "Gênero",
            "Editora",
            "Ano",
            "Exemplares",
          ];

          const trs = booksList.querySelectorAll("tr");
          trs.forEach((tr) => {
            if (tr.style.display === "none") return;
            const cols = tr.querySelectorAll("td");
            rows.push([
              cols[1].textContent,
              cols[2].textContent,
              cols[3].textContent,
              cols[4].textContent,
              cols[5].textContent,
              cols[6].textContent,
            ]);
          });

          doc.autoTable({
            head: [headers],
            body: rows,
            startY: 30,
          });
          doc.save("lista_de_livros.pdf");
        });
      });

      // --- Exportar CSV ---
      const exportCsvBtn = document.getElementById("exportCsvBtn");
      exportCsvBtn.addEventListener("click", () => {
        const headers = [
          "Título",
          "Autor",
          "Gênero",
          "Editora",
          "Ano",
          "Exemplares",
        ];
        const rows = [];
        const trs = booksList.querySelectorAll("tr");
        trs.forEach((tr) => {
          if (tr.style.display === "none") return;
          const cols = tr.querySelectorAll("td");
          rows.push([
            cols[1].textContent,
            cols[2].textContent,
            cols[3].textContent,
            cols[4].textContent,
            cols[5].textContent,
            cols[6].textContent,
          ]);
        });

        let csvContent = headers.join(",") + "\n";
        rows.forEach((r) => {
          csvContent +=
            r
              .map((cell) =>
                `"${cell.replace(/"/g, '""')}"`
              ) // aspas duplas escape
              .join(",") + "\n";
        });

        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "lista_de_livros.csv";
        a.click();
        URL.revokeObjectURL(url);
      });

      // --- Offline notification ---
      const offlineNotification = document.getElementById("offlineNotification");

      function updateOnlineStatus() {
        if (!navigator.onLine) {
          offlineNotification.style.display = "block";
          offlineNotification.textContent = "Você está offline. Algumas funções podem não funcionar.";
        } else {
          offlineNotification.style.display = "none";
          offlineNotification.textContent = "";
        }
      }

      window.addEventListener("online", updateOnlineStatus);
      window.addEventListener("offline", updateOnlineStatus);
      updateOnlineStatus();
    });
  </script>
</body>
</html>
