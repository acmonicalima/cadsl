<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sala de Leitura | JOÃO VITTA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script type="module">
      // Import do Firebase
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
      import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

      // Configuração do Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyC72gBi7POz-NqEMWKgu54S9vTyr0oFkzs",
        authDomain: "cadsl-3ef8f.firebaseapp.com",
        projectId: "cadsl-3ef8f",
        storageBucket: "cadsl-3ef8f.firebasestorage.app",
        messagingSenderId: "556775341028",
        appId: "1:556775341028:web:c7c76dd36e7f17411925f1"
      };

      // Inicializa o Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const dbFirestore = getFirestore(app);

      // Exporta para usar no resto do código
      window.firebase = { auth, dbFirestore };
    </script>
    <!-- Bibliotecas para PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <!-- Tesseract para OCR -->
    <script src="https://unpkg.com/tesseract.js@v5.0.0/dist/tesseract.min.js"></script>
    <style>
        :root {
            --primary: #4a6fa5;
            --secondary: #166088;
            --light: #f8f9fa;
            --dark: #343a40;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background-color: var(--primary);
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        header h1 {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.8rem;
        }
        nav {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        nav button {
            background: none;
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        nav button:hover {
            background-color: rgba(255,255,255,0.1);
        }
        nav button.active {
            background-color: rgba(255,255,255,0.2);
            font-weight: bold;
        }
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 20px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--secondary);
        }
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        .btn-success:hover {
            background-color: #218838;
        }
        .btn-warning {
            background-color: var(--warning);
            color: #000;
        }
        .btn-warning:hover {
            background-color: #e0a800;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .table th, .table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        .table tr:hover {
            background-color: #f5f5f5;
        }
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .action-btn i {
            pointer-events: none;
        }
        .book-cover {
            width: 80px;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
        }
        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        .status-available {
            background-color: #d4edda;
            color: #155724;
        }
        .status-loaned {
            background-color: #fff3cd;
            color: #856404;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        .tab.active {
            border-bottom: 3px solid var(--primary);
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            text-align: center;
        }
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
            margin: 10px 0;
        }
        .stat-title {
            font-size: 1rem;
            color: #6c757d;
        }
        /* Responsive */
        @media (max-width: 768px) {
            nav {
                flex-direction: column;
                gap: 10px;
            }
            .action-buttons {
                flex-direction: column;
            }
            .stats-container {
                grid-template-columns: 1fr;
            }
            .table {
                display: block;
                overflow-x: auto;
            }
        }
        /* Offline notification */
        .offline-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--warning);
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
        }
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
        }
    </style>
</head>
<body>

  <!-- Tela de Login -->
  <div id="login-screen" style="display: none; text-align: center; padding: 50px; background: #f5f5f5; min-height: 100vh;">
    <div style="background: white; padding: 30px; border-radius: 10px; display: inline-block; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
      <h2><i class="fas fa-book"></i> Sala de Leitura</h2>
      <p><strong>JOÃO VITTA</strong></p>
      <input type="email" id="email" placeholder="E-mail" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;">
      <input type="password" id="password" placeholder="Senha" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;">
      <button onclick="login()" class="btn btn-primary">Entrar</button>
    </div>
  </div>

  <!-- App Principal -->
  <div id="main-app" style="display: none;">

    <header>
      <div class="container">
        <h1>
          <i class="fas fa-book"></i> Sala de Leitura | JOÃO VITTA
        </h1>
        <button id="logoutBtn" onclick="logout()" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; float: right;">Sair</button>
      </div>
    </header>

    <div class="container">
      <!-- Tab Contents -->
      <div id="books" class="tab-content active">
        <div class="card">
          <h2><i class="fas fa-book"></i> Cadastrar Novo Livro</h2>
          <form id="bookForm">
            <div class="flex-container">
              <div class="form-group">
                <label for="title">Título:</label>
                <input type="text" id="title" class="form-control" required>
              </div>
              <div class="form-group">
                <label for="author">Autor:</label>
                <input type="text" id="author" class="form-control" required>
              </div>
            </div>
            <div class="flex-container">
              <div class="form-group">
                <label for="genre">Gênero:</label>
                <select id="genre" class="form-control" required>
                  <option value="">Selecione...</option>
                  <option value="Literatura">Literatura</option>
                  <option value="Ficção">Ficção</option>
                  <option value="Não Ficção">Não Ficção</option>
                  <option value="Infantil">Infantil</option>
                  <option value="Educacional">Educacional</option>
                  <option value="Biografia">Biografia</option>
                </select>
              </div>
              <div class="form-group">
                <label for="publisher">Editora:</label>
                <input type="text" id="publisher" class="form-control" required>
              </div>
            </div>
            <div class="flex-container">
              <div class="form-group">
                <label for="year">Ano:</label>
                <input type="number" id="year" class="form-control" min="1900" max="2023" required>
              </div>
              <div class="form-group">
                <label for="copies">Exemplares:</label>
                <input type="number" id="copies" class="form-control" min="1" required>
              </div>
            </div>
            <div class="form-group">
              <label for="cover">Capa do Livro:</label>
              <input type="file" id="cover" accept="image/*" class="form-control">
              <div id="coverPreview" style="margin-top: 10px;"></div>
            </div>
            <!-- Botão para extrair dados da imagem -->
            <div class="form-group">
              <button type="button" class="btn btn-primary" id="extractFromImage">
                <i class="fas fa-image"></i> Preencher com Imagem
              </button>
            </div>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i> Salvar Livro
            </button>
            <!-- Botão para limpar o formulário -->
            <button type="button" class="btn btn-warning" id="limparFormBtn" style="margin-left: 10px;">
              <i class="fas fa-eraser"></i> Limpar Formulário
            </button>
          </form>
        </div>
        <div class="card">
          <h2><i class="fas fa-list"></i> Lista de Livros</h2>
          <div class="search-container">
            <input type="text" id="searchBooks" class="form-control" placeholder="Buscar por título ou autor...">
            <button class="btn btn-primary" id="searchBtn">
              <i class="fas fa-search"></i> Buscar
            </button>
          </div>
          <table class="table" id="booksTable">
            <thead>
              <tr>
                <th>Capa</th>
                <th>Título</th>
                <th>Autor</th>
                <th>Gênero</th>
                <th>Exemplares</th>
                <th>Status</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="booksList">
            </tbody>
          </table>
        </div>
      </div>

      <div id="reports" class="tab-content">
        <div class="card">
          <h2><i class="fas fa-chart-bar"></i> Relatórios Gerenciais</h2>
          <div class="stats-container">
            <div class="stat-card">
              <i class="fas fa-book stat-icon"></i>
              <div class="stat-value" id="totalBooks">0</div>
              <div class="stat-title">Livros Cadastrados</div>
            </div>
            <div class="stat-card">
              <i class="fas fa-check-circle stat-icon"></i>
              <div class="stat-value" id="availableBooks">0</div>
              <div class="stat-title">Livros Disponíveis</div>
            </div>
          </div>
          <div class="card">
            <h3><i class="fas fa-star"></i> Livros Cadastrados</h3>
            <table class="table" id="topBooksTable">
              <thead>
                <tr>
                  <th>Título</th>
                  <th>Autor</th>
                  <th>Gênero</th>
                  <th>Editora</th>
                  <th>Ano</th>
                  <th>Exemplares</th>
                </tr>
              </thead>
              <tbody id="topBooksList">
              </tbody>
            </table>
            <button class="btn btn-success" id="generatePDF">
              <i class="fas fa-file-pdf"></i> Gerar Relatório em PDF
            </button>
          </div>
        </div>
      </div>

      <div id="settings" class="tab-content">
        <div class="card">
          <h2><i class="fas fa-cog"></i> Configurações</h2>
          <div class="form-group">
            <label for="schoolName">Nome da Escola:</label>
            <input type="text" id="schoolName" class="form-control" value="CIEP BRIZOLÃO 183 - JOÃO VITTA">
          </div>
          <div class="form-group">
            <button id="exportBtn" class="btn btn-success">
              <i class="fas fa-file-export"></i> Exportar Dados (CSV)
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Offline Notification -->
    <div class="offline-notification" id="offlineNotification">
      <i class="fas fa-wifi"></i> Modo offline
    </div>

  </div>

  <script>
    // Banco de dados local (para fallback)
    const db = {
      books: [],
      settings: {
        schoolName: 'CIEP BRIZOLÃO 183 - JOÃO VITTA'
      }
    };

    // Função para verificar login
    function verificarAutenticacao() {
      const loginScreen = document.getElementById('login-screen');
      const mainApp = document.getElementById('main-app');

      window.firebase.auth.onAuthStateChanged((user) => {
        if (user) {
          loginScreen.style.display = 'none';
          mainApp.style.display = 'block';
          carregarLivrosDoFirestore(); // Carrega os dados do Firebase
          document.getElementById('schoolName').value = db.settings.schoolName;
        } else {
          loginScreen.style.display = 'block';
          mainApp.style.display = 'none';
        }
      });
    }

    // Função de login
    function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      signInWithEmailAndPassword(window.firebase.auth, email, password)
        .then(() => {
          console.log('Login bem-sucedido');
        })
        .catch((error) => {
          alert('Erro no login: ' + error.message);
        });
    }

    // Função de logout
    function logout() {
      signOut(window.firebase.auth).then(() => {
        alert('Logout realizado com sucesso!');
      });
    }

    // Salvar livro no Firestore
    async function salvarNoFirestore(livro) {
      try {
        await addDoc(collection(window.firebase.dbFirestore, 'livros'), livro);
      } catch (e) {
        console.error('Erro ao salvar no Firestore:', e);
      }
    }

    // Carregar livros do Firestore em tempo real
    function carregarLivrosDoFirestore() {
      onSnapshot(collection(window.firebase.dbFirestore, 'livros'), (snapshot) => {
        db.books = [];
        snapshot.forEach((doc) => {
          db.books.push({ id: doc.id, ...doc.data() });
        });
        updateBooksList();
        updateStats();
      });
    }

    // Atualizar lista de livros
    function updateBooksList(filter = '') {
      const list = document.getElementById('booksList');
      list.innerHTML = '';
      const filtered = filter 
        ? db.books.filter(b => 
            b.title.toLowerCase().includes(filter.toLowerCase()) || 
            b.author.toLowerCase().includes(filter.toLowerCase()))
        : db.books;

      filtered.forEach(book => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><img src="${book.coverImage || 'https://via.placeholder.com/80x100'}" class="book-cover"></td>
          <td>${book.title}</td>
          <td>${book.author}</td>
          <td>${book.genre}</td>
          <td>${book.copies}</td>
          <td><span class="status-badge status-available">Disponível</span></td>
          <td class="action-buttons">
            <button class="action-btn btn-danger" data-id="${book.id}" data-action="delete">
              <i class="fas fa-trash-alt"></i>
            </button>
          </td>
        `;
        list.appendChild(row);
      });
    }

    // Adicionar livro
    document.getElementById('bookForm').addEventListener('submit', e => {
      e.preventDefault();
      const title = document.getElementById('title').value;
      const author = document.getElementById('author').value;
      const genre = document.getElementById('genre').value;
      const publisher = document.getElementById('publisher').value;
      const year = parseInt(document.getElementById('year').value);
      const copies = parseInt(document.getElementById('copies').value);
      const coverInput = document.getElementById('cover');
      let coverImage = null;
      if (coverInput.files.length > 0) {
        coverImage = URL.createObjectURL(coverInput.files[0]);
      }

      const newBook = {
        title,
        author,
        genre,
        publisher,
        year,
        copies,
        coverImage
      };

      salvarNoFirestore(newBook);
      document.getElementById('bookForm').reset();
      document.getElementById('coverPreview').innerHTML = '';
    });

    // Pré-visualização da capa
    document.getElementById('cover').addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = ev => {
          document.getElementById('coverPreview').innerHTML = `
            <img src="${ev.target.result}" style="max-width: 100px; max-height: 100px; margin-top: 10px;">
          `;
        };
        reader.readAsDataURL(file);
      }
    });

    // Botão: Limpar formulário
    document.getElementById('limparFormBtn').addEventListener('click', () => {
      document.getElementById('bookForm').reset();
      document.getElementById('coverPreview').innerHTML = '';
      document.getElementById('cover').value = '';
    });

    // OCR: Preencher com imagem
    document.getElementById('extractFromImage').addEventListener('click', async () => {
      const fileInput = document.getElementById('cover');
      const file = fileInput.files[0];
      if (!file) {
        alert('Por favor, selecione uma imagem da capa do livro.');
        return;
      }

      alert('Processando imagem... (pode demorar alguns segundos)');
      try {
        const result = await Tesseract.recognize(file, 'por+eng');
        const text = result.data.text;
        const title = extrairTitulo(text) || '';
        const author = extrairAutor(text) || '';

        document.getElementById('title').value = title;
        document.getElementById('author').value = author;
      } catch (err) {
        console.error('Erro no OCR:', err);
        alert('Erro ao processar imagem. Tente novamente.');
      }
    });

    function extrairTitulo(texto) {
      const linhas = texto.split('\n').filter(l => l.trim().length > 0);
      return linhas[0]?.trim() || '';
    }

    function extrairAutor(texto) {
      const linhas = texto.split('\n');
      for (let linha of linhas) {
        if (/autor|por|de|by|written/i.test(linha)) {
          return linha.replace(/autor|por|de|by|written/i, '').trim();
        }
      }
      return linhas[1]?.trim() || '';
    }

    // Exportar para CSV
    document.getElementById('exportBtn').addEventListener('click', () => {
      const csv = [
        ['Título', 'Autor', 'Gênero', 'Editora', 'Ano', 'Exemplares'].join(';')
      ];
      db.books.forEach(b => {
        csv.push([
          b.title,
          b.author,
          b.genre,
          b.publisher,
          b.year,
          b.copies
        ].join(';'));
      });
      const csvContent = '\uFEFF' + csv.join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `livros_sala_leitura_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.csv`;
      a.click();
    });

    // Gerar PDF
    document.getElementById('generatePDF').addEventListener('click', () => {
      const doc = new jspdf.jsPDF();
      const school = document.getElementById('schoolName').value || 'Sala de Leitura';
      const date = new Date().toLocaleDateString('pt-BR');
      doc.setFontSize(18);
      doc.text(`${school} - Relatório de Livros`, 14, 20);
      doc.setFontSize(12);
      doc.text(`Gerado em: ${date}`, 14, 30);
      const tableData = db.books.map(b => [
        b.title,
        b.author,
        b.genre,
        b.publisher,
        b.year,
        b.copies
      ]);
      doc.autoTable({
        head: [['Título', 'Autor', 'Gênero', 'Editora', 'Ano', 'Exemplares']],
        body: tableData,
        startY: 40
      });
      doc.save(`relatorio_livros_${date}.pdf`);
    });

    // Abas
    document.querySelectorAll('nav button').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(btn.getAttribute('data-tab')).classList.add('active');
      });
    });

    // Buscar livros
    document.getElementById('searchBtn').addEventListener('click', () => {
      const term = document.getElementById('searchBooks').value.toLowerCase();
      updateBooksList(term);
    });

    // Configurações
    document.getElementById('schoolName').addEventListener('change', e => {
      db.settings.schoolName = e.target.value;
    });

    // Atualizar estatísticas
    function updateStats() {
      document.getElementById('totalBooks').textContent = db.books.length;
      document.getElementById('availableBooks').textContent = db.books.length;
    }

    // Inicializar
    document.addEventListener('DOMContentLoaded', () => {
      verificarAutenticacao();
    });
  </script>
</body>
</html>
