<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sala de Leitura | JOÃO VITTA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK (Modular) -->
    <script type="module">
      // Importa o Firebase
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
      import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

      // Configuração do seu projeto
      const firebaseConfig = {
        apiKey: "AIzaSyC72gBi7POz-NqEMWKgu54S9vTyr0oFkzs",
        authDomain: "cadsl-3ef8f.firebaseapp.com",
        projectId: "cadsl-3ef8f",
        storageBucket: "cadsl-3ef8f.firebasestorage.app",
        messagingSenderId: "556775341028",
        appId: "1:556775341028:web:c7c76dd36e7f17411925f1"
      };

      // Inicializa o Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const dbFirestore = getFirestore(app);

      // Torna disponível globalmente (para uso no script principal)
      window.firebaseConfig = firebaseConfig;
      window.firebase = { auth, dbFirestore, signInWithEmailAndPassword, signOut, collection, addDoc, onSnapshot };
    </script>
    <!-- Bibliotecas para PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <!-- Tesseract para OCR -->
    <script src="https://unpkg.com/tesseract.js@v5.0.0/dist/tesseract.min.js"></script>
    <style>
        :root {
            --primary: #4a6fa5;
            --secondary: #166088;
            --light: #f8f9fa;
            --dark: #343a40;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background-color: var(--primary);
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        header h1 {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.8rem;
            justify-content: center;
        }
        nav {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 10px;
        }
        nav button {
            background: none;
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        nav button:hover {
            background-color: rgba(255,255,255,0.1);
        }
        nav button.active {
            background-color: rgba(255,255,255,0.2);
            font-weight: bold;
        }
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 20px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--secondary);
        }
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        .btn-success:hover {
            background-color: #218838;
        }
        .btn-warning {
            background-color: var(--warning);
            color: #000;
        }
        .btn-warning:hover {
            background-color: #e0a800;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .table th, .table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        .table tr:hover {
            background-color: #f5f5f5;
        }
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .action-btn i {
            pointer-events: none;
        }
        .book-cover {
            width: 80px;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
        }
        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        /* Responsive */
        @media (max-width: 768px) {
            nav {
                flex-direction: column;
                gap: 10px;
            }
            .action-buttons {
                flex-direction: column;
            }
            .table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>

  <!-- Tela de Login -->
  <div id="login-screen" style="display: none; text-align: center; padding: 50px; background: #f5f5f5; min-height: 100vh;">
    <div style="background: white; padding: 30px; border-radius: 10px; display: inline-block; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
      <h2><i class="fas fa-book"></i> Sala de Leitura</h2>
      <p><strong>JOÃO VITTA</strong></p>
      <input type="email" id="email" placeholder="E-mail" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;">
      <input type="password" id="password" placeholder="Senha" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;">
      <button onclick="login()" class="btn btn-primary">Entrar</button>
    </div>
  </div>

  <!-- App Principal -->
  <div id="main-app" style="display: none;">
    <header>
      <div class="container">
        <h1>
          <i class="fas fa-book"></i> Sala de Leitura | JOÃO VITTA
        </h1>
        <button id="logoutBtn" onclick="logout()" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; float: right;">Sair</button>
      </div>
    </header>

    <div class="container">
      <div id="books" class="tab-content active">
        <div class="card">
          <h2><i class="fas fa-book"></i> Cadastrar Novo Livro</h2>
          <form id="bookForm">
            <div class="form-group">
              <label for="title">Título:</label>
              <input type="text" id="title" class="form-control" required>
            </div>
            <div class="form-group">
              <label for="author">Autor:</label>
              <input type="text" id="author" class="form-control" required>
            </div>
            <div class="form-group">
              <label for="genre">Gênero:</label>
              <select id="genre" class="form-control" required>
                <option value="">Selecione...</option>
                <option value="Literatura">Literatura</option>
                <option value="Ficção">Ficção</option>
                <option value="Não Ficção">Não Ficção</option>
                <option value="Infantil">Infantil</option>
                <option value="Educacional">Educacional</option>
                <option value="Biografia">Biografia</option>
              </select>
            </div>
            <div class="form-group">
              <label for="publisher">Editora:</label>
              <input type="text" id="publisher" class="form-control" required>
            </div>
            <div class="form-group">
              <label for="year">Ano:</label>
              <input type="number" id="year" class="form-control" min="1900" max="2023" required>
            </div>
            <div class="form-group">
              <label for="copies">Exemplares:</label>
              <input type="number" id="copies" class="form-control" min="1" required>
            </div>
            <div class="form-group">
              <label for="cover">Capa do Livro:</label>
              <input type="file" id="cover" accept="image/*" class="form-control">
              <div id="coverPreview" style="margin-top: 10px;"></div>
            </div>
            <div class="form-group">
              <button type="button" class="btn btn-primary" id="extractFromImage">
                <i class="fas fa-image"></i> Preencher com Imagem
              </button>
            </div>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i> Salvar Livro
            </button>
            <button type="button" class="btn btn-warning" id="limparFormBtn" style="margin-left: 10px;">
              <i class="fas fa-eraser"></i> Limpar Formulário
            </button>
          </form>
        </div>
        <div class="card">
          <h2><i class="fas fa-list"></i> Lista de Livros</h2>
          <div class="search-container">
            <input type="text" id="searchBooks" class="form-control" placeholder="Buscar por título ou autor...">
            <button class="btn btn-primary" id="searchBtn">
              <i class="fas fa-search"></i> Buscar
            </button>
          </div>
          <table class="table" id="booksTable">
            <thead>
              <tr>
                <th>Capa</th>
                <th>Título</th>
                <th>Autor</th>
                <th>Gênero</th>
                <th>Exemplares</th>
              </tr>
            </thead>
            <tbody id="booksList">
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Banco de dados local (para fallback)
    const db = { books: [] };

    // Verifica autenticação
    function verificarAutenticacao() {
      const loginScreen = document.getElementById('login-screen');
      const mainApp = document.getElementById('main-app');

      window.firebase.auth.onAuthStateChanged((user) => {
        if (user) {
          loginScreen.style.display = 'none';
          mainApp.style.display = 'block';
          carregarLivrosDoFirestore();
        } else {
          loginScreen.style.display = 'block';
          mainApp.style.display = 'none';
        }
      });
    }

    // Função de login CORRETA
    function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      // ✅ Agora sim: usamos a função importada
      window.firebase.signInWithEmailAndPassword(window.firebase.auth, email, password)
        .then(() => {
          alert('Login realizado com sucesso!');
        })
        .catch((error) => {
          alert('Erro no login: ' + error.message);
        });
    }

    // Função de logout
    function logout() {
      window.firebase.signOut(window.firebase.auth).then(() => {
        alert('Logout realizado com sucesso!');
      });
    }

    // Carregar livros do Firestore
    function carregarLivrosDoFirestore() {
      window.firebase.onSnapshot(window.firebase.collection(window.firebase.dbFirestore, 'livros'), (snapshot) => {
        db.books = [];
        snapshot.forEach((doc) => {
          db.books.push({ id: doc.id, ...doc.data() });
        });
        updateBooksList();
      });
    }

    // Salvar livro no Firestore
    function salvarNoFirestore(livro) {
      window.firebase.addDoc(window.firebase.collection(window.firebase.dbFirestore, 'livros'), livro)
        .catch(e => console.error('Erro ao salvar:', e));
    }

    // Atualizar lista
    function updateBooksList() {
      const list = document.getElementById('booksList');
      list.innerHTML = '';
      db.books.forEach(book => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><img src="${book.coverImage || 'https://via.placeholder.com/80x100'}" class="book-cover"></td>
          <td>${book.title}</td>
          <td>${book.author}</td>
          <td>${book.genre}</td>
          <td>${book.copies}</td>
        `;
        list.appendChild(row);
      });
    }

    // Formulário
    document.getElementById('bookForm').addEventListener('submit', e => {
      e.preventDefault();
      const newBook = {
        title: document.getElementById('title').value,
        author: document.getElementById('author').value,
        genre: document.getElementById('genre').value,
        publisher: document.getElementById('publisher').value,
        year: parseInt(document.getElementById('year').value),
        copies: parseInt(document.getElementById('copies').value),
        coverImage: document.getElementById('coverPreview').querySelector('img')?.src || null
      };
      salvarNoFirestore(newBook);
      document.getElementById('bookForm').reset();
      document.getElementById('coverPreview').innerHTML = '';
    });

    // Botão limpar
    document.getElementById('limparFormBtn').addEventListener('click', () => {
      document.getElementById('bookForm').reset();
      document.getElementById('coverPreview').innerHTML = '';
      document.getElementById('cover').value = '';
    });

    // OCR
    document.getElementById('extractFromImage').addEventListener('click', async () => {
      const file = document.getElementById('cover').files[0];
      if (!file) return alert('Selecione uma imagem');
      try {
        const result = await Tesseract.recognize(file, 'por+eng');
        document.getElementById('title').value = extrairTitulo(result.data.text) || '';
        document.getElementById('author').value = extrairAutor(result.data.text) || '';
      } catch (err) {
        alert('Erro no OCR: ' + err.message);
      }
    });

    function extrairTitulo(texto) {
      return texto.split('\n').filter(l => l.trim().length > 0)[0]?.trim() || '';
    }
    function extrairAutor(texto) {
      return texto.split('\n').find(l => /autor|por|de/i.test(l))?.replace(/autor|por|de/i, '').trim() || '';
    }

    // Busca
    document.getElementById('searchBtn').addEventListener('click', () => {
      const term = document.getElementById('searchBooks').value.toLowerCase();
      updateBooksList();
      const filtered = db.books.filter(b => 
        b.title.toLowerCase().includes(term) || 
        b.author.toLowerCase().includes(term)
      );
      // (lógica de atualização da lista filtrada)
    });

    // Inicializar
    document.addEventListener('DOMContentLoaded', verificarAutenticacao);
  </script>
</body>
</html>
